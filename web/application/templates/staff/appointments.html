{% extends 'staff/shared/layout.html' %}
{% block title %}
    Appointments
{% endblock %}

{% block css %}
<style>
.timeline-container {
    position: relative;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #fff;
    padding: 0;
    height: 600px; /* adjust based on your screen */
    font-family: "Inter", sans-serif;
    
}

.my-element {
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.timeline-container::-webkit-scrollbar {
      display: none;
}

/* Header for Bays (columns) */
.timeline-header {
    display: flex;
    position: sticky;
    top: 0;
    background: #fff;
    border-bottom: 2px solid #dee2e6;
    z-index: 5;
}

/* First header column (e.g. “Bays”) */
.timeline-header > div:first-child {
    width: 80px; /* fixed width for the first column */
    flex-shrink: 0;
    text-align: center;
    padding: 10px 0;
    border-right: 2px solid #dee2e6;
    background: #f8f9fa;
    font-weight: bold;
}

/* All other columns */
.timeline-header > div:not(:first-child) {
    flex: 1; /* spread out evenly */
    text-align: center;
    padding: 10px 0;
    border-right: 1px solid #dee2e6;
}


.timeline-bay-label {
    width: 80px;
    text-align: center;
    padding: 0.5rem;
    font-weight: 600;
    color: #495057;
    border-left: 1px solid #e9ecef;
}

/* Body containing hours vertically */
.timeline-body {
    position: relative;
    display: flex;
}

/* Time labels column */
.timeline-time {
    width: 80px;
    border-right: 2px solid #dee2e6;
    background: #fff;
    flex-shrink: 0;
}

.timeline-hour {
    height: 60px; /* each hour = 60px */
    border-bottom: 1px solid #e9ecef;
    font-size: 0.85rem;
    text-align: right;
    padding-right: 6px;
    color: #6c757d;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
}

/* Bay Columns */
.timeline-column {
    position: relative;
    flex: 1;
    min-width: 150px;
    border-left: 1px solid #e9ecef;
    background: repeating-linear-gradient(
        to bottom,
        #f8f9fa,
        #f8f9fa 59px,
        #e9ecef 60px
    );
}

/* Appointment blocks */
.bay-badge {
    position: absolute;
    left: 10px;
    right: 10px;
    border-radius: 8px;
    color: #fff;
    padding: 6px 10px;
    font-size: 0.85rem;
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.bay-badge.badge-primary {
    background: linear-gradient(135deg, #7a8999, #546578);
}

.bay-badge.badge-secondary {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

.bay-badge.badge-danger {
    background: linear-gradient(135deg, #dc3545, #a71d2a);
}

.bay-badge.badge-success {
    background: linear-gradient(135deg, #64dc35, #29a71d);
}


/* Current Time Line */
.current-time-line {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background: red;
    z-index: 10;
    pointer-events: none;
    opacity: 0.8;
}
</style>
{% endblock %}


{% block modal %}
<div class="modal fade" id="modal-booking">
    <div class="modal-dialog">
        <div class="modal-content card bg-secondary shadow">
            <div class="modal-header card-header bg-white border-0">
                <h4 class="card-title" id="modal-booking-title">Book New Appointment</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="form-control-label">
                                Customer
                            </label>
                            <select required id="customer_id" name="customer_id" 
                                    data-style="bg-03 px-4 py-3" class="form-control selectpicker" 
                                    data-live-search="true" data-max-options="1"
                                    onchange="UpdateVehicleOptions(this)">
                                <option value="" disabled selected>Select an existing customer</option>
                                {% for i in data.customers | selectattr('is_registered') %}
                                    <option value="{{i.id}}">{{i.account.full_name}}</option>
                                {% endfor %}
                                {% for i in data.customers | rejectattr('is_registered') %}
                                    <option hidden value="{{i.id}}">{{i.account.full_name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                        <label class="form-control-label">Vehicle ID</label>
                        <select required id="vehicle_id" name="vehicle_id"
                                data-style="bg-white px-4 py-3 shadow-sm" class="form-control selectpicker"
                                data-live-search="true" data-max-options="1"
                                onchange="UpdateVehicleTypeOptions(this)">
                            <option value="" disabled selected>Select a vehicle type first</option>
                        </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                        <label class="form-control-label">Vehicle Type</label>
                        <select required id="vehicle_type" name="vehicle_type"
                                data-style="bg-white px-4 py-3 shadow-sm" class="form-control selectpicker"
                                data-live-search="true" data-max-options="1"
                                onchange="UpdateServiceOptions(this)">
                            <option value="" disabled selected>Select an option</option>
                            {% for i in data.services|map(attribute='type')|unique|list %}
                            <option value="{{ i }}">{{ i }}</option>
                            {% endfor %}
                        </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                        <label class="form-control-label">Service</label>
                        <select required id="service_id" name="service_id"
                                data-style="bg-white px-4 py-3 shadow-sm" class="form-control selectpicker"
                                data-live-search="true" data-max-options="1" onchange="CheckAppointments()">
                            <option value="" disabled selected>Select a vehicle type first</option>
                        </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="appointment_date" class="form-control-label">Appointment Date</label>
                            <input class="form-control form-control-alternative" type="datetime-local" id="appointment_date" onchange="CheckAppointments()">
                        </div>
                        <span id="appointment_date_error" class="text-danger"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-md btn-danger" data-dismiss="modal">Cancel</button>
                <button id="save_quick_book" class="btn btn-md btn-success" onclick="SaveQuickBook()">BOOK NOW</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-status">
    <div class="modal-dialog">
        <div class="modal-content card bg-secondary shadow">
            <div class="modal-header card-header bg-white border-0">
                <h4 class="card-title" id="modal-booking-title">Appointment Status</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <input id="appointment_id" name="appointment_id" type="text" class="form-control form-control-alternative" hidden value="-1">
            </div>
            <div class="modal-body card-body">
                <div class="row">
                    <div class="col-md-12">                            
                        <label class="form-control-label">Payments</label>
                    </div>
                    <div class="col-md-12">
                        <div class="table-responsive">
                            <table id="paymentsTable" class="table align-items-center table-flush">
                                <thead>
                                    <tr>
                                        <th>Payment Date</th>
                                        <th>Method</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center;">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="form-control-label">Set Status</label>
                            <select required id="status_id" name="status_id"
                                    data-style="bg-white px-4 py-3 shadow-sm" 
                                    class="form-control selectpicker"
                                    data-max-options="1">
                                {% for status in data.status %}
                                    <option value="{{status.id}}">{{status.status}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-md btn-danger" data-dismiss="modal">Cancel</button>
                <button class="btn btn-md btn-success" onclick="SaveStatus()">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main-content" id="panel">
    <!-- Header -->
    <div class="header bg-primary pb-6">
        <div class="container-fluid">
            <div class="header-body">
                <div class="row align-items-center py-4">
                    <div class="col-lg-6 col-7">
                        <p class="display-2 text-white d-inline-block mb-0">Appointments</p>
                    </div>
                </div>
            </div>  
        </div>
    </div>

    <!-- Page content -->
    <div class="container-fluid mt--6">
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header border-0">
                        <button type="submit" class="btn btn-primary m-0 float-right" onclick="QuickBook()">Quick Book</button>
                        <div class="nav-wrapper">
                            <ul class="nav nav-pills" id="tabs-icons-text" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link mb-sm-3 mb-md-0 active" id="tabs-icons-text-1-tab" data-toggle="tab" href="#tabs-icons-text-1" role="tab" aria-controls="tabs-icons-text-1" aria-selected="true" onclick="scrollToCurrentTime()">
                                        <i class="ni ni-shop mr-2"></i>Bays
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link mb-sm-3 mb-md-0" id="tabs-icons-text-3-tab" data-toggle="tab" href="#tabs-icons-text-3" role="tab" aria-controls="tabs-icons-text-3" aria-selected="false">
                                        <i class="ni ni-calendar-grid-58 mr-2"></i>Upcoming
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade show active" id="tabs-icons-text-1" role="tabpanel" aria-labelledby="tabs-icons-text-1-tab">
                                        <div class="timeline-container" id="timelineContainer">
                                            
                                            <!-- BAY HEADER -->
                                            <div class="timeline-header">
                                                <div class="timeline-bay-label" style="border-left:none;">Time</div>
                                                {% for col in data.bays.columns %}
                                                <div class="timeline-bay-label">{{ col }}</div>
                                                {% endfor %}
                                            </div>

                                            <!-- TIMELINE BODY -->
                                            <div class="timeline-body">
                                                <!-- Left Time Scale -->
                                                <div class="timeline-time">
                                                    {% for hour in range(24) %}
                                                        {% set display_hour = hour % 12 %}
                                                        {% if display_hour == 0 %}
                                                            {% set display_hour = 12 %}
                                                        {% endif %}
                                                        {% set am_pm = "AM" if hour < 12 else "PM" %}
                                                        <div class="timeline-hour">
                                                            {{ display_hour }}:00 {{ am_pm }}
                                                        </div>
                                                    {% endfor %}
                                                </div>

                                                <!-- Bay Columns -->
                                                {%  for n in range(data.bays.columns|length) %}
                                                <div class="timeline-column">
                                                    {% for rows in data.bays.rows %}
                                                        {% set bay = rows[n] %}
                                                        {% if bay %}
                                                            {% set start = bay.start_time.hour + (bay.start_time.minute / 60) %}
                                                            {% set end = bay.end_time.hour + (bay.end_time.minute / 60) %}
                                                            {% set duration = end - start %}
                                                            {% set top = start * 60 %}   {# 60px per hour #}
                                                            {% set height = duration * 60 %}
                                                            <div class="bay-badge 
                                                                    {% if bay.status.id == 5 %} badge-danger
                                                                    {% elif bay.status.id == 3 %} badge-secondary 
                                                                    {% elif bay.status.id == 4 %} badge-success 
                                                                    {% else %} badge-primary
                                                                    {% endif %}"
                                                                style="top: {{ top }}px; height: {{ height }}px; cursor:pointer;"
                                                                data-appointment-id="{{ bay.id }}"
                                                                data-customer-id="{{ bay.customer.id }}"
                                                                data-customer-name="{{ bay.customer.account.full_name }}"
                                                                data-vehicle-id="{{ bay.vehicle.id }}"
                                                                data-vehicle-type="{{ bay.vehicle.type }}"
                                                                data-service-id="{{ bay.service.id }}"
                                                                data-status-id="{{ bay.status.id }}"
                                                                data-start="{{ bay.start_time.strftime('%Y-%m-%dT%H:%M') }}"
                                                                onclick="AppointmentStatus(this)">
                                                                <strong>
                                                                    {{ bay.service.name }}
                                                                    ({% for staff in bay.staffs %}{{staff.account.full_name}}{% if not loop.last %}, {% endif %}{% endfor %})
                                                                </strong><br>
                                                                {{ bay.start_time.strftime("%I:%M%p") }} - {{ bay.end_time.strftime("%I:%M%p") }}
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                {% endfor %}

                                                <!-- Current Time Line -->
                                                <div class="current-time-line" id="currentTimeLine"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="tab-pane fade" id="tabs-icons-text-3" role="tabpanel" aria-labelledby="tabs-icons-text-3-tab">
                                        <div class="table-responsive">
                                            <!-- Projects table -->
                                            <table class="table align-items-center table-flush">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th scope="col">Date & Time</th>
                                                        <th scope="col">Bay - Service</th>
                                                        <th scope="col">Customer - Vehicle</th>
                                                        <th scope="col">Assignee</th>
                                                        <th scope="col">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for appointment in data.upcoming | sort(attribute="start_time") %}
                                                        <tr>
                                                            <th scope="row">
                                                                {{ appointment.start_time.strftime("%I:%M%p") }} - {{ appointment.end_time.strftime("%I:%M%p") }}
                                                                <br>
                                                                {{ appointment.start_time.strftime("%a %b %d, %Y") }} 
                                                            </th>
                                                            <td>
                                                                {{ appointment.bay.bay }} <i class="fa fa-arrow-right"></i> {{ appointment.service.name }} ({{ appointment.service.type }})
                                                            </td>
                                                            <td>
                                                                {{ appointment.customer.account.full_name }}
                                                                {% if appointment.vehicle.plate_number %}
                                                                    <br> {{ appointment.vehicle.plate_number }} {{ appointment.vehicle.model }}
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% for staff in appointment.staffs %}
                                                                    {{ staff.account.full_name }} <br>
                                                                {% endfor %}
                                                            </td>
                                                            <td>
                                                                {{ appointment.status.status }}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>
  const SERVICES = {{ data.services | tojson | safe }};
  const VEHICLES = {{ data.vehicles | tojson | safe }};
</script>

<script>
setSideBar('#menu-appointments');

let isEditing = false; // flag to know if we're editing or creating
const modal = '#modal-booking';
const bookButton = document.getElementById('save_quick_book');

const formFields = {
    customer: document.getElementById('customer_id'),
    vehicle: document.getElementById('vehicle_id'),
    vehicleType: document.getElementById('vehicle_type'),
    service: document.getElementById('service_id'),
    date: document.getElementById('appointment_date')
};

function isFormValid() {
    return (
        formFields.service.value
        // formFields.vehicleType.value &&
        // formFields.service.value &&
        // formFields.customer.value &&
        // formFields.date.value
    );
}

function toggleBookButton() {
    bookButton.disabled = !isFormValid();
}

function showError(id, message) {
    document.getElementById(id).innerHTML = `<small class="text-danger">${message}</small>`;
}

function clearError(id) {
    document.getElementById(id).innerHTML = '';
}

// ---------------------------
// MODAL HANDLING
// ---------------------------
function QuickBook() {
    clearError('appointment_date_error');
    openQuickBookModal();
}

function openQuickBookModal(element = null) {
    $(modal).modal({
        backdrop: 'static',
        keyboard: true,
        show: true
    });

    // Reset modal first
    formFields.customer.selectedIndex = 0;
    formFields.vehicle.innerHTML = '<option value="" disabled selected>Select a vehicle</option>';
    formFields.vehicleType.selectedIndex = 0;
    formFields.service.innerHTML = '<option value="" disabled selected>Select a vehicle type first</option>';

    
    // Create a new Date object for the current time
    const now = new Date();

    // Adjust for the timezone offset to get local time
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());

    // Format the date and time to the required "YYYY-MM-DDTHH:MM" format
    // slice(0, 16) extracts the first 16 characters (YYYY-MM-DDTHH:MM)
    const formattedDatetime = now.toISOString().slice(0, 16);

    // Set the value of the datetime-local input
    formFields.date.value = formattedDatetime;
    $('.selectpicker').selectpicker('refresh');

    // If element is passed, edit existing appointment
    if (element) {
        isEditing = true;

        const customerId = element.dataset.customerId;
        const vehicleId = element.dataset.vehicleId;
        const vehicleType = element.dataset.vehicleType;
        const serviceId = element.dataset.serviceId;
        const appointmentId = element.dataset.appointmentId;
        const startTime = element.dataset.start;

        // Pre-select fields
        formFields.customer.value = customerId;
        UpdateVehicleOptions(formFields.customer);

        setTimeout(() => {
            formFields.vehicle.value = vehicleId;
            $('.selectpicker').selectpicker('refresh');
            UpdateVehicleTypeOptions(formFields.vehicle);

            setTimeout(() => {
                formFields.vehicleType.value = vehicleType;
                $('.selectpicker').selectpicker('refresh');
                UpdateServiceOptions(formFields.vehicleType);

                setTimeout(() => {
                    formFields.service.value = serviceId;
                    formFields.date.value = startTime;
                    $('.selectpicker').selectpicker('refresh');
                    toggleBookButton();
                }, 100);
            }, 100);
        }, 100);

        // store id for saving
        formFields.customer.dataset.appointmentId = appointmentId;
        document.querySelector('#save_quick_book').innerText = 'UPDATE APPOINTMENT';
    } else {
        isEditing = false;
        formFields.customer.dataset.appointmentId = '';
        document.querySelector('#save_quick_book').innerText = 'BOOK NOW';
    }

    document.getElementById('modal-booking-title').innerText = isEditing ? 'Edit Appointment' : 'Book New Appointment';

}

// ---------------------------
// FORM LOGIC
// ---------------------------

function UpdateVehicleOptions(element) {
    const selectedCustomerId = parseInt(element.value);
    const vehicleDropdown = formFields.vehicle;
    vehicleDropdown.innerHTML = '<option value="" disabled selected>Select a vehicle</option>';

    // Filter vehicles owned by selected customer
    const filteredVehicles = VEHICLES.filter(v => v.customer_id === selectedCustomerId);
    filteredVehicles.forEach(v => {
        const option = document.createElement('option');
        option.value = v.id;
        option.textContent = `${v.model} (${v.plate_number || 'No Plate'})`;
        option.dataset.type = v.type; // store type for auto-selection later
        vehicleDropdown.appendChild(option);
    });

    $('.selectpicker').selectpicker('refresh');
    toggleBookButton();
}

function UpdateVehicleTypeOptions(element) {
    const selectedVehicleId = parseInt(element.value);
    const selectedVehicle = VEHICLES.find(v => v.id === selectedVehicleId);
    if (!selectedVehicle) return;

    // Smart vehicle type mapping
    formFields.vehicleType.value = selectedVehicle.type.includes("Bike")
        ? "Motorcycle"
        : selectedVehicle.type;

    $('.selectpicker').selectpicker('refresh');
    UpdateServiceOptions(formFields.vehicleType); // auto-update service list
    toggleBookButton();
}

function UpdateServiceOptions(element) {
    const selectedType = element.value;
    const serviceDropdown = formFields.service;
    serviceDropdown.innerHTML = '<option value="" disabled selected>Select a service</option>';

    const filteredServices = SERVICES.filter(s => s.type === selectedType);
    filteredServices.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${s.name} - ₱${s.price} - ETA ${s.duration} mins`;
        serviceDropdown.appendChild(option);
    });

    $('.selectpicker').selectpicker('refresh');
    toggleBookButton();
}

function CheckAppointments() {
    clearError('appointment_date_error');

    const data = {
        appointment_date: formFields.date.value,
        service_id: formFields.service.value
    };

    if (!data.appointment_date || !data.service_id) {
        toggleBookButton();
        return;
    }

    Controller.POST('/api/check_or_suggest_appointment', data).done(function(result) {
        const res = result.message;

        if (res.available) {
            showError('appointment_date_error', '<span class="text-success">Slot available ✅</span>');
        } else {
            let msg = `<strong>${res.message}</strong>`;
            if (res.suggestions && res.suggestions.length > 0) {
                msg += '<br><br>Suggested Slots:<br>';
                res.suggestions.forEach(s => {
                    msg += `<div class="text-info">${s.schedule}</div>`;
                });
            }
            showError('appointment_date_error', msg);
        }
    });

    toggleBookButton();
}

function SaveQuickBook() {
    if (!isFormValid()) {
        alert('Please fill in all required fields.');
        return;
    }

    const data = {
        vehicle_type: formFields.vehicleType.value,
        vehicle_id: formFields.vehicle.value,
        service_id: formFields.service.value,
        customer_id: formFields.customer.value,
        appointment_date: formFields.date.value
    };

    // If editing, include appointment_id
    if (isEditing && formFields.customer.dataset.appointmentId) {
        data.id = formFields.customer.dataset.appointmentId;
        // data.appointment_id = formFields.customer.dataset.appointmentId;
    }

    const endpoint = isEditing ? '/api/appointment/upsert' : '/api/quick_book';
    // const endpoint = '/api/quick_book';

    console.log("Submitting data:", data);

    Controller.POST(endpoint, data).done(function(result) {
        if (result.success) {
            $(modal).modal('hide');
            location.reload();
        } else if (result.errors) {
            if (result.errors.vehicle_type) showError('vehicle_type_error', result.errors.vehicle_type);
            if (result.errors.service_id) showError('service_id_error', result.errors.service_id);
            if (result.errors.customer_id) showError('customer_id_error', result.errors.customer_id);
            if (result.errors.appointment_date) showError('appointment_date_error', result.errors.appointment_date);
        } else {
            alert(result.message || 'Something went wrong.');
        }
    });
}

</script>

<script>
    
// ---------------------------
// UTILITIES
// ---------------------------
function updateCurrentTimeLine() {
    const line = document.getElementById('currentTimeLine');
    const container = document.getElementById('timelineContainer');
    if (!line || !container) return;

    const now = new Date();
    const hours = now.getHours() + now.getMinutes() / 60 + now.getSeconds() / 3600;
    const topPx = hours * 60; // 1 hour = 60px height
    line.style.top = `${topPx}px`;

    return topPx;
}

function scrollToCurrentTime() {
    const container = document.getElementById('timelineContainer');
    const topPx = updateCurrentTimeLine();
    if (!container || topPx === undefined) return;
    container.scrollTo({ top: topPx - 100, behavior: 'smooth' });
}

// Initial position & scroll
window.addEventListener('DOMContentLoaded', () => {
    scrollToCurrentTime();
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
    if (e.target.id === "tabs-icons-text-1-tab") {
      scrollToCurrentTime();
    }
  });
});

// Update every minute to keep the red line accurate
setInterval(updateCurrentTimeLine, 60000);

// ---------------------------
// REAL-TIME VALIDATION EVENTS
// ---------------------------
Object.values(formFields).forEach(field => {
    field.addEventListener('change', toggleBookButton);
    field.addEventListener('input', toggleBookButton);
});

</script>

<script>
    
const modal_status = '#modal-status';

function AppointmentStatus(element = null) {
    
    const tbody = document.getElementById("paymentsBody");
    tbody.innerHTML = "";  // clear previous rows

    $(modal_status).modal({
        backdrop: 'static',
        keyboard: true,
        show: true
    });
    
    Controller.GET('/api/appointment/get/'+element.dataset.appointmentId, {}).done(function(result) {
        console.log(result)

        payments = result.data.payments
        service = result.data.service

        if (payments.length === 0) {
            row = document.createElement("tr");
            row.innerHTML = `
                <td colspan="3" style="text-align: center;">No records found</td>
            `;
            tbody.appendChild(row);
            row = document.createElement("tr");
            row.innerHTML = `
                <td colspan="2" style="text-align: right; border: 1px solid #e9ecef;">Service Cost</td>
                <td style="text-align: right; border: 1px solid #e9ecef;">${parseFloat(service.price).toFixed(2)}</td>
            `;
            tbody.appendChild(row);

            return;
        }

        total_payment = 0;

        payments.forEach(item => {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td style="border: 1px solid #e9ecef;">${new Date(item.created_at).toLocaleString()}</td>
                <td style="border: 1px solid #e9ecef;">${item.method}</td>
                <td style="text-align: right; border: 1px solid #e9ecef;">${parseFloat(item.amount).toFixed(2)}</td>
            `;

            tbody.appendChild(row);
            total_payment += item.amount;
        });

        row = document.createElement("tr");
        row.innerHTML = `
            <td colspan="3" style="border: 1px solid #e9ecef;"></td>
        `;
        tbody.appendChild(row);
        row = document.createElement("tr");
        row.innerHTML = `
            <td colspan="2" style="text-align: right; border: 1px solid #e9ecef;">Service Cost</td>
            <td style="text-align: right; border: 1px solid #e9ecef;">${parseFloat(service.price).toFixed(2)}</td>
        `;
        tbody.appendChild(row);

        row = document.createElement("tr");
        row.innerHTML = `
            <td colspan="2" style="text-align: right; border: 1px solid #e9ecef;">Balance</td>
            <td style="text-align: right; border: 1px solid #e9ecef;">${parseFloat(service.price - total_payment).toFixed(2)}</td>
        `;
        tbody.appendChild(row);

    });

    $('#appointment_id').val(element.dataset.appointmentId)
    $('.selectpicker').selectpicker('refresh');
    $("#status_id").selectpicker('val', element.dataset.statusId)

}

function SaveStatus() {
    data = {
        'appointment_id': $('#appointment_id').val(),
        'status_id': $('#status_id').val()
    }
    console.log(data)
    Controller.POST('/api/appointment/set/status', data).done(function(result) {
        if (result.success) {
            $(modal).modal('hide');
            location.reload();
        }
    });
}

</script>

{% endblock %}
